<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Deaths in Malaysia by State (2023)</title>
  <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
  <style>
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: #fff; }
    .container { max-width: 980px; margin: 24px auto; padding: 0 16px; }
    h1 { font-size: 20px; margin: 12px 0; }
    .note { color:#555; font-size: 12px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Deaths in Malaysia by State (2023)</h1>
    <div id="vis"></div>
    <p class="note">Data: death_sex_ethnic_state.csv &nbsp;|&nbsp; Boundaries: GADM Level-1 (states + federal territories). Units: absolute number of deaths.</p>
  </div>

<script>
const spec = {
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "width": 900,
  "height": 540,
  "projection": {
  "type": "mercator",
  "center": [109.3, 4.2],   // long, lat roughly center of Malaysia
  "scale": 2200             // zoom level for your 900x540 canvas
}
,
  "params": [
  {
    "name": "yearParam",
    "value": 2023,
    "bind": {"input":"range", "min":2000, "max":2023, "step":1, "name":"Year: "}
  },
  {
    "name": "sexParam",
    "value": "both",
    "bind": {"input":"select", "options":["male","female","both"], "name":" Sex: "}
  },
  {
    "name": "ethParam",
    "value": "overall",
    "bind": {"input":"select", "options":["overall","bumiputera","chinese","indian","others"], "name":" Ethnicity: "}
  }
],
  "layer": [
    /* Ocean background for figureâ€“ground */
    {
      "data": {"sphere": true},
      "mark": {"type":"geoshape", "fill":"#eef3f7"}
    },
    /* Graticule */
    {
      "data": {"graticule": {"step":[10,10]}},
      "mark": {"type":"geoshape", "stroke":"#cdd6df", "strokeWidth":0.6}
    },
    /* Choropleth (CSV joined to GeoJSON geometry) */
    {
      "data": {"url": "death_sex_ethnic_state.csv"},
      "transform": [
        {"calculate": "year(toDate(datum.date))", "as":"year"},
        {"filter": "datum.year == yearParam && datum.sex == sexParam && datum.ethnicity == ethParam"},

        /* Harmonize state names: remove 'W.P. ' prefix, remove spaces, fix Terengganu spelling */
        {"calculate": "replace(datum.state, 'W.P. ', '')", "as": "state_nowp"},
        {"calculate": "replace(datum.state_nowp, ' ', '')", "as": "state_compact"},
        {"calculate": "datum.state_compact == 'Terengganu' ? 'Trengganu' : datum.state_compact", "as": "state_key"},

        /* Lookup geometry from GeoJSON (GADM NAME_1 is compacted e.g., 'PulauPinang', 'NegeriSembilan') */
        {
          "lookup": "state_key",
          "from": {
            "data": {
              "url": "gadm41_MYS_1.json",
              "format": {"type":"json", "property":"features"}
            },
            "key": "properties.NAME_1",
            "fields": ["geometry","properties.NAME_1"]
          }
        }
      ],
      "mark": {"type":"geoshape"},
      "encoding": {
        "shape": {"field":"geometry", "type":"geojson"},
        "color": {
          "field":"abs", "type":"quantitative",
          "title":"Deaths (count)",
          "scale":{"scheme":"blues"}
        },
        "tooltip": [
          {"field":"properties.NAME_1", "title":"State"},
          {"field":"year","type":"ordinal","title":"Year"},
          {"field":"sex","title":"Sex"},
          {"field":"ethnicity","title":"Ethnicity"},
          {"field":"abs","type":"quantitative","title":"Deaths","format":","}
        ]
      }
    },
    /* Outline for crisp borders */
    {
      "data": {
        "url": "gadm41_MYS_1.json",
        "format": {"type":"json", "property":"features"}
      },
      "mark": {"type":"geoshape", "fill": null, "stroke":"#7c8ea4", "strokeWidth":0.6}
    }
  ],
  "config": {
    "legend": {"orient":"right"},
    "view": {"stroke": null},
    "background": "white"
  },
  "title": {
    "text": "Deaths in Malaysia by State, 2023 (Sex: Both, Ethnicity: Overall)",
    "fontSize": 16,
    "color": "#222",
    "anchor": "start",
    "subtitle": "Choropleth by state (GADM Level-1)."
  }
};

vegaEmbed('#vis', spec, {actions:false});
</script>
</body>
</html>